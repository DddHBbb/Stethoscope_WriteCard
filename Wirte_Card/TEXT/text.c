#include "oled.h"
#include "fontupd.h"
#include "w25qxx.h"
#include "text.h"
#include "string.h"
#include "usart.h"

//code 字符指针开始
//从字库中查找出字模
//code 字符串的开始地址,GBK码
//mat  数据存放地址 (size/8+((size%8)?1:0))*(size) bytes大小
//size:字体大小
void Get_HzMat(unsigned char *code, unsigned char *mat, u8 size)
{
    unsigned char qh, ql;
    unsigned char i;
    unsigned long foffset;
    u8 csize = (size / 8 + ((size % 8) ? 1 : 0)) * (size); //得到字体一个字符对应点阵集所占的字节数
    qh = *code;
    ql = *(++code);
    if (qh < 0x81 || ql < 0x40 || ql == 0xff || qh == 0xff) //非 常用汉字
    {
        for (i = 0; i < csize; i++)
            *mat++ = 0x00; //填充满格
        return;            //结束访问
    }
    if (ql < 0x7f)
        ql -= 0x40; //注意!
    else
        ql -= 0x41;
    qh -= 0x81;
    foffset = ((unsigned long)190 * qh + ql) * csize; //得到字库中的字节偏移量
    switch (size)
    {
    case 12:
        W25QXX_Read(mat, foffset + ftinfo.f12addr, csize);
        break;
    case 16:
        W25QXX_Read(mat, foffset + ftinfo.f16addr, csize);
        break;
    case 24:
        W25QXX_Read(mat, foffset + ftinfo.f24addr, csize);
        break;
    case 32:
        W25QXX_Read(mat, foffset + ftinfo.f32addr, csize);
        break;
    }
}
//显示一个指定大小的汉字
//x,y :汉字的坐标
//font:汉字GBK码
//size:字体大小
//mode:0,正常显示,1,叠加显示
void Show_Font(u16 x, u16 y, u16 xend, u16 yend, u16 size, u8 *font)
{
    u8 temp, t, pos, color = 1;
    u16 y0 = y;
    u8 dzk[128];
    u8 csize = (size / 8 + ((size % 8) ? 1 : 0)) * (size); //得到字体一个字符对应点阵集所占的字节数
    if (size != 12 && size != 16 && size != 24 && size != 32)
        return;                 //不支持的size
    Get_HzMat(font, dzk, size); //得到相应大小的点阵数据
    for (pos = 0; pos < size * 2; pos++)
    {
        if (x > xend)
            break;       //到达终点坐标
        temp = dzk[pos]; //得到点阵数据
        for (t = 0; t < 8; t++)
        {
            if (y <= yend)
            {
                if (temp & 0x80)
                    OLED_DrawPoint(x, y, color);
                else
                    OLED_DrawPoint(x, y, !color);
            }
            temp <<= 1;
            y++;
            if ((y - y0) == size)
            {
                y = y0;
                x++;
                break;
            }
        }
    }
}
